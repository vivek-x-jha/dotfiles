#!/usr/bin/env zsh

# Open all non-binary files in current directory
local files=()

# Patterns to skip
local excludes=(
  '.cache'
  '.direnv'
  '.git'
  '.github'
  '.idea'
  '.terraform'
  '.venv'
  'Icon?'
  'Session.vim'
  '__pycache__'
  'dist'
  'node_modules'
  'target'
  'vendor'
)

# Runtime vars for command building and iteration
local pat f mime cmd=()

# Build command (prefer fd; fallback to find)
if command -v fd &>/dev/null; then
  cmd=(fd -HItf -0)
  for pat in "${excludes[@]}"; do cmd+=(--exclude "$pat"); done
else
  cmd=(find . \()
  for pat in "${excludes[@]}"; do cmd+=(-name "$pat" -o); done
  cmd=("${cmd[@]:0:${#cmd[@]}-1}")
  cmd+=(-prune -o -type f -print0 \))
fi

# Collect only text-ish files by MIME type
while IFS= read -r -d '' f; do
  mime=$(file -b --mime-type "$f")
  case "$mime" in
  text/* | application/json | application/xml | application/x-sh | application/javascript | application/x-yaml | application/yaml | application/toml)
    files+=("$f")
    ;;
  esac
done < <("${cmd[@]}")

# Launch editor with collected files (if any)
if ((${#files[@]})); then
  "$EDITOR" "${files[@]}"
else
  printf "No non-binary files to edit in %s\n" "$PWD"
fi
