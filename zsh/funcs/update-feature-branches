#!/usr/bin/env zsh

local default=main
local branches=("$@")

# Dynamically fetch feature branches if no arguments are passed
if [[ $# -eq 0 ]]; then
  branches=()
  while IFS= read -r b; do
    [[ -n $b ]] && branches+=("$b")
  done < <(git branch --format='%(refname:short)' | grep '^feature/')
fi

if [[ -z ${branches[1]} ]]; then
  printf "${BRIGHTYELLOW}[WARN] no feature branches updated${RESET}\n"
  printf "${BRIGHTBLUE}[INFO] run ${GREEN}\`git branch\`${BRIGHTBLUE} to show available branches\n"
else
  for branch in "${branches[@]}"; do
    # Check if branch exists
    if ! git branch --format='%(refname:short)' | grep -Fxq "$branch"; then
      printf "${BRIGHTRED}[ERROR] '%s' not found${RESET}\n" "$branch"
      continue
    fi

    # Perform merge
    git switch "$branch" &>/dev/null
    git merge "$default" &>/dev/null

    # Print success message
    printf "${GREEN}âœ” ${RESET}${CYAN}%s${RESET} -> ${MAGENTA}${default}${RESET}\n" "$branch"
  done
fi

# Always return to main branch (once)
git switch "$default" &>/dev/null
