#!/usr/bin/env zsh

local branches=("$@")

# Ensure git is available
command -v git &>/dev/null || {
  printf "${RED}[ERROR] git not found on PATH${RESET}\n" >&2
  return 1
}

local default=$(git config --get init.defaultBranch 2>/dev/null)
default=${default:-main}

# Collect branches: passed args + any feature/* branches present
local feature_branches="$(git for-each-ref --format='%(refname:short)' refs/heads/feature)"
[[ -n $feature_branches ]] && branches+=("${(f)feature_branches}")

# Drop any empty entries (e.g., when nothing matched)
{
  local filtered=()
  local b
  for b in "${branches[@]}"; do
    [[ -n $b ]] && filtered+=("$b")
  done
  branches=("${filtered[@]}")
}

# Exit early if no branches collected
(( ${#branches[@]} )) || {
  printf "${YELLOW}[WARN] no feature branches updated${RESET}\n"
  printf "${BLACK}[INFO] run ${GREEN}\`git branch\`${BLACK} to show available branches\n"
  return
}

local branch=''

for branch in "${branches[@]}"; do
  # Skip branch if not in refs list
  git show-ref --verify --quiet "refs/heads/$branch" || {
    printf "${RED}[ERROR] '%s' not found${RESET}\n" "$branch"
    continue
  }

  # Merge branch into default branch
  git switch "$branch" &>/dev/null
  git merge "$default" &>/dev/null
  printf "${GREEN}âœ” ${RESET}${CYAN}%s${RESET} -> ${MAGENTA}${default}${RESET}\n" "$branch"
done

# Always return to default branch
git switch "$default" &>/dev/null
