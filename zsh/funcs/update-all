#!/usr/bin/env zsh

# Usage: update-all [IconsDir]
#   IconsDir  (optional): directory containing custom macOS icons (default: ~/Pictures/icons)
local icons_dir="${1:-$HOME/Pictures/icons}"

local ICON='ó°“’'
local STEP=0
local SUBSTEP=0
local TOTAL_STEPS=5

logg() {
  local level=INFO color="$BLACK" cmd=''

  case "${1-}" in
  -w) level=WARN && color="$YELLOW" && shift ;;
  -e) level=ERROR && color="$MAGENTA" && shift ;;
  -c) cmd="$2" && shift 2 ;;
  esac

  local message="$*"
  if [[ -n $cmd ]]; then
    message="Running ${GREEN}${cmd}${RESET}"
  fi

  printf '%b[%s] %b%b\n' "$color" "$level" "$message" "$RESET"
  if [[ -n $cmd ]]; then
    eval "$cmd"
    return $?
  fi
}

notify() {
  local minor=''
  case "$1" in
  -s) SUBSTEP=$((SUBSTEP + 1)) && minor=".$SUBSTEP" && shift ;;
  *) STEP=$((STEP + 1)) && SUBSTEP=0 ;;
  esac
  printf '\n%b%s [%d%s/%d] %s %s%b\n' "$BLUE" "$ICON" "$STEP" "$minor" "$TOTAL_STEPS" "$*" "$ICON" "$RESET"
}

notify 'PRUNE .DS_STORE ARTIFACTS'
logg -c "fd -HI .DS_Store / -x rm -f {} &>/dev/null &" 2>/dev/null ||
  logg -c "find / -name '.DS_Store' -print -delete &>/dev/null &"

notify 'UPDATE ZSH PLUGINS'
logg -c 'zap update all' 2>/dev/null ||
  logg -w "ZAP NOT FOUND ON \$PATH; SKIPPING ZSH PLUGINS UPDATE"

notify 'UPDATE TMUX PLUGINS'
logg -c "$TMUX_PLUGIN_MANAGER_PATH/tpm/bin/update_plugins all" 2>/dev/null ||
  logg -w 'UPDATE TMUX PLUGINS FAILED'

notify 'RUN HOMEBREW MAINTENANCE'
notify -s 'UPGRADE FORMULAE AND CASKS'
logg -c 'brew upgrade' || logg -w 'UPDATE HOMEBREW FORMULAE FAILED'
logg -c 'brew cu -af' || logg -w 'UPDATE HOMEBREW CASKS FAILED'

notify -s 'RUN QUARANTINE CHECKS'
local apps=(
  Arc
  ChatGPT
  Slack
  Spotify
  WhatsApp
)

for app in "${apps[@]}"; do
  logg -c "sudo xattr -rd com.apple.quarantine \"/Applications/${app}.app\"" ||
    logg -w "FAILED TO CLEAR ${app^^} QUARANTINE"
done

logg -c 'brew cleanup' || logg -w 'HOMEBREW CLEANUP FAILED'
logg -c 'brew doctor' || logg -w 'HOMEBREW DOCTOR FAILED'

notify -s 'EXPORT BREWFILE'
logg -c "brew bundle dump --force" || logg -w 'UPDATE BREWFILE FAILED'

notify 'REFRESH MACOS ICONS'
update-icons "$icons_dir" || logg -w 'FAILED TO UPDATE MACOS ICONS'

# Optional: Update TeX Live Utility (uncomment if used)
# sudo tlmgr update --self --all
